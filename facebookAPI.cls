/**

@author Innodel Technologies PVT LTD
@date 9 th NOV 2016
@description Class is for Authentication request Methods to Facebook
Facebook_SCOPE: share Posts
Callback to : https://c.ap2.visual.force.com/apex/facebookintegrationcallback
User Account of facebook is staff.innodel@gmail.com
*/
global class facebookAPI
{
    global static string accesstokens{get;set;}
   public static string client_id ='dsfdfd';
     public static string client_secret ='dfdgf';
     public static string sf_accesstokenurl ='https://graph.facebook.com/v2.8/oauth/access_token';
     public static string sf_callbackpage ='https://socialforces-developer-edition.ap2.force.com/FBintegrationtest';
     public static string fb_field{get;set;}     
    public static Facebook_oauth_Setting__c objfb_oauth_setting {get;set;}
    /**
        @date 10 th NOV 2016
        @description Method is used to deserialize JSON code generated by verious API calls.
        @param jsonstring is API call Result .
        @param fieldname is the field which you want to retrive. 
    */
    public static String deserializefacebookfield(string jsonstring,string fieldname) 
    {
        JSONParser parser = JSON.createParser(jsonstring);
        while (parser.nextToken() != null) 
        {
            if ((parser.getCurrentToken() == JSONToken.FIELD_NAME) &&(parser.getText() == fieldname)) 
            {              
                parser.nextToken();
                fb_field=parser.getText();
             
            }
        }
        return fb_field;
    }
    /**
        @date 10 th NOV 2016
        @description Method is used to Get Accesstoken from the Accesstoken URL.
        @param code is the Authorizasion code.
        @param client is the client ID or App ID of the facebook developer account. 
        @param secret is the Client Secret or App Secret of the Facebook developer Account.
    */    
    public static String gotAccessTocken(String code,String client,String secret)
     {        
        
                     
             PageReference p = new PageReference(sf_accesstokenurl+'?');
             p.getParameters().put('client_id',client);
             p.getParameters().put('redirect_uri',sf_callbackpage);
             p.getParameters().put('client_secret',secret);
             p.getParameters().put('code',code);             
             String body = p.getURL();
             body = body.subStringAfter('?');
             HttpRequest req = new HttpRequest();
             req.setEndpoint(sf_accesstokenurl);
             req.setMethod('POST');          
             req.setCompressed(false);             
             req.setTimeout(120000);//max timeout
             if(body != null )
             { 
                 req.setBody(body);
                 req.setHeader('Content-length',string.valueOf(body.length()));
             }
             HttpResponse res = new http().send(req);
            // return res.getBody();
             return deserializefacebookfield(res.getBody(),'access_token'); // retrieves access token and returns it
                 
         
     }
    /**
        @date 10 th NOV 2016
        @description Method is used to Get Own Profile Data using API call to my profile.
        @param token is the Access token of Facebook.
    */
    public static String getownprofile(String token)
    {
            Http http =new Http();
            HttpRequest req =new HttpRequest();
            req.setEndpoint('https://graph.facebook.com/me?fields=id,name,email,picture&access_token='+token);
            req.setmethod('GET');
            req.setHeader('Content-Type','application/json');
            HttpResponse res = http.send(req);             
            return res.getBody();
                    
    }
    /**
        @date 11 th NOV 2016
        @description Method is used to Get Own Profile Name traversing to Json populated from getownprofile.
        @param Jsonstring is the Json response of profile data of Logged In user.
    */
     public static String getownname(String Jsonstring)
     {
              return deserializefacebookfield(Jsonstring,'name'); // retrieves name and returns it
     }
     /**
        @date 11 th NOV 2016
        @description Method is used to Get Own Profile id traversing to Json populated from getownprofile.
        @param Jsonstring is the Json response of profile data of Logged In user.
    */
     public static String getownid(String Jsonstring)
     {
              return deserializefacebookfield(Jsonstring,'id'); // retrieves id and returns it
     }
     /**
        @date 11 th NOV 2016
        @description Method is used to Get Own Profile cover photo traversing to Json populated from getownprofile.
        @param Jsonstring is the Json response of profile data of Logged In user.
    */
     public static String getowncover(String Jsonstring)
     {
              return deserializefacebookfield(Jsonstring,'source'); // retrieves coverphoto and returns it
     }
      /**
        @date 11 th NOV 2016
        @description Method is used to Get Own Profile Email ID traversing to Json populated from getownprofile.
        @param Jsonstring is the Json response of profile data of Logged In user.
    */
     public static String getownemail(String Jsonstring)
     {
              return deserializefacebookfield(Jsonstring,'email'); // retrieves email and returns it
     }
     /**
        @date 11 th NOV 2016
        @description Method is used to Get Own Profile Email ID traversing to Json populated from getownprofile.
        @param Jsonstring is the Json response of profile data of Logged In user.
    */
     public static String getownpicture(String Jsonstring)
     {
              return deserializefacebookfield(Jsonstring,'url'); // retrieves email and returns it
     }
      /**
        @date 10 th NOV 2016
        @description Method is used to Get Own Profile Data using API call to my profile.
        @param token is the Access token of Facebook.
    */
    public static String sharepostownprofile(String post,String pid,String token)
    {

         Map<String,String> params = new Map<String,String>();
         params.put('access_token',token);
         params.put('message',post);
         String endpoint = 'https://graph.facebook.com/'+pid+'/feed/';
        Http h = new Http();
        HttpRequest req = new HttpRequest();
        req.setEndpoint(endpoint);
        req.setTimeOut(120000);
        req.setMethod('POST');
        req.setBody(convertParamMaptoString(params));

        HttpResponse res = h.send(req);
        String response = res.getBody();
        if(res.getStatusCode() == 302)
        {
            response = '{"data": [{"url": "'+res.getHeader('Location')+'"},]}';
        } 
        return   response;
                    
    }
    public static String convertParamMaptoString(Map<String,String> params){
        String returned = '';
        for(String key : params.keySet()){
            if(returned == ''){
                //returned += ‘?’;
            }
            else {
                returned += '&';
            }
            returned += key+'='+EncodingUtil.urlEncode(params.get(key), 'UTF-8');
        }
        return returned;
    }
    public static String getpage(String token)
    {
            Http http =new Http();
            HttpRequest req =new HttpRequest();
            req.setEndpoint('https://graph.facebook.com/me?fields=accounts&access_token='+token);
            req.setmethod('GET');
            req.setHeader('Content-Type','application/json');
            HttpResponse res = http.send(req);             
            return res.getBody();
    }
     public static String getpageid(String json)
    {
             return deserializefacebookfield(json,'id');
    }
    public static String getpageaccesstoken(String json)
    {
             return deserializefacebookfield(json,'access_token');
    }
    public static String getpagename(String json)
    {
             return deserializefacebookfield(json,'name');
    }
    public static String getpagepost(String token,string pid)
    {
            Http http =new Http();
            HttpRequest req =new HttpRequest();
            req.setEndpoint('https://graph.facebook.com/'+pid+'/feed?access_token='+token);
            req.setmethod('GET');
            req.setHeader('Content-Type','application/json');
            HttpResponse res = http.send(req);             
            return res.getBody();             
    }
    

}